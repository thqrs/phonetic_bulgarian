<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Translitera√ß√µes</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ---------- Design system ---------- */
    :root{
      --bg: #0b1220;           /* page bg */
      --surface: #0f172a;      /* cards/toolbars */
      --text: #e6eaf3;
      --muted: #9aa4b2;
      --accent: #60a5fa;       /* buttons & focus */
      --accent-2:#34d399;      /* success */
      --accent-3:#f59e0b;      /* warning */
      --border:#1f2a44;
      --chip-1: rgba(96,165,250,.15);
      --chip-2: rgba(52,211,153,.15);
      --chip-3: rgba(245,158,11,.15);
      --shadow: 0 6px 20px rgba(2,6,23,.25);
      --radius: 14px;
      --gap: 14px;
      --font: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#5b6472;
      --border:#e6e9f2;
      --shadow: 0 6px 20px rgba(2,6,23,.08);
      --chip-1: rgba(96,165,250,.22);
      --chip-2: rgba(52,211,153,.22);
      --chip-3: rgba(245,158,11,.22);
    }
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:radial-gradient(1200px 700px at 10% -10%, #c7d2fe33 0%, transparent 40%),
                 radial-gradient(900px 500px at 90% -10%, #7dd3fc33 0%, transparent 45%),
                 var(--bg);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased;
      line-height:1.45;
      display:flex; flex-direction:column;
    }
    .container{
      width:min(1100px, 92vw);
      margin: clamp(16px, 4vw, 32px) auto;
      display:flex; flex-direction:column; gap:var(--gap);
    }

    /* ---------- Toolbar ---------- */
    .toolbar{
      position:sticky; top:0; z-index:8;
      padding:12px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--surface), transparent 0%) 0%, var(--surface) 38%);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:12px;
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .toolbar-row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(44px, 1fr));
      gap:10px;
      align-items:center;
    }
    .toolbar-row.audio{
      grid-template-columns: auto 1fr auto auto;
      gap:12px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:10px 12px;
      border-radius:12px; border:1px solid var(--border);
      background:color-mix(in oklab, var(--surface), #ffffff10 10%);
      color:var(--text); cursor:pointer; user-select:none;
      transition:transform .05s ease, background .2s ease, border-color .2s ease;
      white-space:nowrap;
    }
    .btn:hover{ background:color-mix(in oklab, var(--surface), #ffffff18 18%) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ background:color-mix(in oklab, var(--accent), black 12%); border-color: transparent; color:white }
    .btn.success{ background:color-mix(in oklab, var(--accent-2), black 12%); border-color: transparent; color:white }
    .btn.warn{ background:color-mix(in oklab, var(--accent-3), black 12%); border-color: transparent; color:white }
    .meter{
      display:inline-grid; grid-auto-flow:column; gap:8px; align-items:center;
      font-variant-numeric: tabular-nums;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
      height: 6px;
    }
    .pill{
      padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; background:var(--surface); color:var(--muted);
      display:inline-flex; gap:6px; align-items:center; font-size:.9rem;
    }

    /* ---------- Cards/sections ---------- */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding: clamp(14px, 3.2vw, 22px);
      box-shadow:var(--shadow);
    }
    h3{ margin:.4em 0 .2em; font-size:1.15rem }
    h4{ margin:0 0 .8em; color:var(--muted); font-weight:500 }
    .row{ display:grid; gap:var(--gap) }
    @media (min-width:880px){
      .row.two{ grid-template-columns: 1.2fr .8fr }
    }

    /* ---------- Word chips ---------- */
    #content{ white-space: pre-wrap; line-height: 2.2; }
    [class^="word-box"]{
      display:inline-block; position:relative;
      padding:.2em .55em 1.8em .55em; margin:0 6px 10px 0;
      border-radius:10px; border:1px solid var(--border);
      box-shadow: 0 1px 0 rgba(0,0,0,.06) inset;
    }
    .word-box1{ background:var(--chip-1) }
    .word-box2{ background:var(--chip-2) }
    .word-box3{ background:var(--chip-3) }
    .transliteration{
      position:absolute; left:50%; bottom:.35em; transform:translateX(-50%);
      font-size:.95em; color:var(--muted)
    }

    /* ---------- Inputs ---------- */
    textarea, input[type="text"], select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--surface); color:var(--text); font:inherit; resize:vertical;
    }
    textarea{ min-height:90px }
    label{ color:var(--muted); font-size:.95rem }
    .actions{ display:flex; gap:10px; flex-wrap:wrap }

    /* ---------- Footer ---------- */
    footer{
      opacity:.9; text-align:center; padding:30px 10px 60px; color:var(--muted)
    }
    footer img{ vertical-align:middle }
    a{ color:var(--accent); text-decoration:none }
    a:hover{ text-decoration:underline }

    /* ---------- Utilities ---------- */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <section class="toolbar card" aria-label="Ferramentas">
      <div class="toolbar-row">
        <button class="btn" id="loadAllTransliterations" title="Mostrar translitera√ß√µes">üí¨</button>
        <button class="btn" id="clearAllTransliterations" title="Ocultar translitera√ß√µes">‚ùå</button>
        <button class="btn" id="increaseMargin" title="Aumentar margem vertical">‚è´</button>
        <button class="btn" id="decreaseMargin" title="Diminuir margem vertical">‚è¨</button>
        <button class="btn" id="decreaseHorizontalMargin" title="Diminuir margem horizontal">‚è™</button>
        <button class="btn" id="increaseHorizontalMargin" title="Aumentar margem horizontal">‚è©</button>
        <button class="btn" id="increaseFontSize" title="Aumentar letra">‚ûï</button>
        <button class="btn" id="decreaseFontSize" title="Diminuir letra">‚ûñ</button>
        <button class="btn" id="toggleDarkMode" title="Tema claro/escuro">üåì</button>
      </div>

      <div class="toolbar-row audio">
        <button class="btn primary" id="playPauseButton" title="Reproduzir/Pausa">‚ñ∂Ô∏è</button>
        <input id="seekBar" type="range" min="0" max="100" value="0" step="1" />
        <div class="meter">
          <span id="currentTimeDisplay">0:00</span>
          <span class="muted">/</span>
          <span id="totalTimeDisplay">0:00</span>
        </div>
        <button class="btn warn" id="stopBtn" title="Parar">‚èπÔ∏è</button>
      </div>

      <div class="toolbar-row">
        <span class="pill">V: <strong id="verticalMarginDisplay">10px</strong></span>
        <span class="pill">H: <strong id="horizontalMarginDisplay">5px</strong></span>
      </div>
    </section>

    <!-- Titles -->
    <section class="card">
      <h3>–¢–µ–∫—Å—Ç –ù–∞ –ü–æ—Ä—Ç—É–≥–∞–ª—Å–∫–∏ –ó–∞ –ß–µ—Ç–µ–Ω–µ:</h3>
      <h4>Texto em Portugu√™s para Ler</h4>
      <div id="content"></div>
    </section>

    <section class="row two">
      <div class="card">
        <h3>–ò—Å–∫–∞–º –î–∞ –ò–∑–ø–æ–ª–∑–≤–∞–º –¢–µ–∫—Å—Ç, –ù–∞–ø–∏—Å–∞–Ω –û—Ç –ú–µ–Ω:</h3>
        <h4>Quero usar um texto escrito por mim</h4>
        <label for="pasteBox" class="sr-only">Introduzir texto</label>
        <textarea id="pasteBox" placeholder="Escrever o texto aqui‚Ä¶"></textarea>
        <div class="actions">
          <button class="btn success" id="processPastedContent">–û–±—Ä–∞–±–æ—Ç–≤–∞–π! ‚úîÔ∏è</button>
        </div>
      </div>

      <div class="card">
        <h3>–ò—Å–∫–∞–º –î–∞ –ò–∑–ø–æ–ª–∑–≤–∞–º –¢–µ–∫—Å—Ç, –ö–æ–π—Ç–æ –°—ä–º –ö–æ–ø–∏—Ä–∞–ª:</h3>
        <h4>Quero usar um texto copiado</h4>
        <button class="btn" id="pasteFromClipboard">üìã‚öôÔ∏è Processar do clipboard</button>
      </div>
    </section>

    <section class="row two">
      <div class="card">
        <h3>–î—É–º–∏, –ö–æ–∏—Ç–æ –ë—è—Ö–∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–∞–Ω–∏:</h3>
        <h4>Palavras transliteradas automaticamente</h4>
        <textarea id="missingTransliterationsBox" placeholder="Palavras n√£o encontradas aparecer√£o aqui‚Ä¶"></textarea>
        <div class="actions">
          <button class="btn" id="copyMissingTransliterations">–ö–æ–ø–∏—Ä–∞–π</button>
        </div>
      </div>

      <div class="card">
        <h3>–ò–∑–±–µ—Ä–µ—Ç–µ –ï–¥–∏–Ω –û—Ç –ü—Ä–µ–¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏—Ç–µ –¢–µ—Å—Ç–æ–≤–∏ –¢–µ–∫—Å—Ç–æ–≤–µ:</h3>
        <h4>Selecionar texto de teste</h4>
        <select id="fileSelector"></select>
      </div>
    </section>

    <section class="row two">
      <div class="card">
        <h3>–ü—Ä–æ–º—è–Ω–∞ –ù–∞ –§–æ–Ω–æ–≤–∞—Ç–∞ –¶–≤—è—Ç:</h3>
        <h4>Modificar a cor de fundo</h4>
        <input type="text" id="colorInput" placeholder="#FF0000, rgb(255,0,0) ou white" />
        <div class="actions">
          <button class="btn" id="applyBgColor">üé® Aplicar</button>
          <button class="btn" id="randomGray">üé≤ Cinza aleat√≥rio</button>
        </div>
      </div>

      <div class="card">
        <h3>Leitor de √Åudio</h3>
        <audio id="audioPlayer" preload="metadata"></audio>
        <p style="color:var(--muted); margin:.5rem 0 0;">O ficheiro √°udio muda consoante o texto selecionado.</p>
      </div>
    </section>

    <footer class="card">
      <p>&copy; 2023 Tiago Henriques. Esta obra est√° licenciada com uma Licen√ßa
        <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer">
          Creative Commons Atribui√ß√£o‚ÄëN√£oComercial 4.0 Internacional
        </a>.
      </p>
      <p>Contact: resourceful.motion(at)gmail.com</p>
      <p><img src="https://licensebuttons.net/l/by-nc/4.0/88x31.png" alt="Licen√ßa CC BY‚ÄëNC 4.0"></p>
    </footer>
  </div>

  <script>
    /* ---------- State ---------- */
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const state = {
      missingTransliterations: [],
      newTransliterations: {},
      phonemeMappings: {},
      theme: localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
    };

    /* ---------- Init ---------- */
    document.documentElement.setAttribute('data-theme', state.theme);

    // Hook up buttons
    qs('#loadAllTransliterations').addEventListener('click', showAllTransliterations);
    qs('#clearAllTransliterations').addEventListener('click', clearAllTransliterations);
    qs('#increaseMargin').addEventListener('click', () => adjustMargin(10));
    qs('#decreaseMargin').addEventListener('click', () => adjustMargin(-10));
    qs('#increaseHorizontalMargin').addEventListener('click', () => adjustHorizontalMargin(5));
    qs('#decreaseHorizontalMargin').addEventListener('click', () => adjustHorizontalMargin(-5));
    qs('#increaseFontSize').addEventListener('click', () => adjustFontSize(1.1));
    qs('#decreaseFontSize').addEventListener('click', () => adjustFontSize(0.9));
    qs('#toggleDarkMode').addEventListener('click', toggleDarkMode);
    qs('#applyBgColor').addEventListener('click', () => changeBackgroundColor(qs('#colorInput').value));
    qs('#randomGray').addEventListener('click', () => changeBackgroundColor(''));
    qs('#pasteFromClipboard').addEventListener('click', processClipboardContent);
    qs('#processPastedContent').addEventListener('click', processPastedContent);
    qs('#copyMissingTransliterations').addEventListener('click', copyMissingTransliterations);
    qs('#fileSelector').addEventListener('change', loadSelectedFile);

    /* ---------- Audio ---------- */
    const audioPlayer = qs('#audioPlayer');
    const seekBar = qs('#seekBar');
    const playPauseButton = qs('#playPauseButton');
    const stopBtn = qs('#stopBtn');
    const currentTimeDisplay = qs('#currentTimeDisplay');
    const totalTimeDisplay = qs('#totalTimeDisplay');

    playPauseButton.addEventListener('click', togglePlayPause);
    stopBtn.addEventListener('click', stopAudio);
    seekBar.addEventListener('input', updateAudioTime);
    seekBar.addEventListener('change', updateAudioTime);

    audioPlayer.addEventListener('loadedmetadata', () => {
      seekBar.max = Math.floor(audioPlayer.duration || 0);
      seekBar.value = 0;
      totalTimeDisplay.textContent = formatTime(audioPlayer.duration || 0);
      currentTimeDisplay.textContent = '0:00';
      playPauseButton.textContent = '‚ñ∂Ô∏è';
    });
    audioPlayer.addEventListener('timeupdate', () => {
      seekBar.value = Math.floor(audioPlayer.currentTime || 0);
      currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime || 0);
    });

    function togglePlayPause(){
      if (audioPlayer.paused || audioPlayer.ended){
        audioPlayer.play();
        playPauseButton.textContent = '‚è∏Ô∏è';
      } else {
        audioPlayer.pause();
        playPauseButton.textContent = '‚ñ∂Ô∏è';
      }
    }
    function stopAudio(){
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      playPauseButton.textContent = '‚ñ∂Ô∏è';
    }
    function updateAudioTime(){ audioPlayer.currentTime = Number(seekBar.value || 0); }
    function formatTime(t){ const m = Math.floor(t/60); const s = Math.floor(t%60); return `${m}:${s<10?'0':''}${s}`; }

    /* ---------- Theming & layout controls ---------- */
    function toggleDarkMode(){
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const next = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }
    function changeBackgroundColor(value){
      const shades = ["#f5f5f5","#e0e0e0","#d6d6d6","#b0b0b0","#a1a1a1","#8c8c8c","#707070","#5c5c5c","#474747","#333333"];
      const selected = value && value.trim() ? value.trim() : shades[Math.floor(Math.random()*shades.length)];
      document.body.style.background = `linear-gradient(0deg, ${selected} 0%, ${selected} 0%), ${getComputedStyle(document.body).backgroundImage}`;
      qs('#colorInput').value = selected;
    }
    function adjustFontSize(mult){
      const content = qs('#content');
      const current = parseFloat(getComputedStyle(content).fontSize) || 16;
      const next = Math.max(10, Math.min(48, current * mult));
      content.style.fontSize = `${next}px`;
    }
    function adjustMargin(pixels){
      let newVal='10px';
      qsa('[class^="word-box"]').forEach(box=>{
        const now = parseFloat(getComputedStyle(box).marginBottom) || 10;
        newVal = (now + pixels) + 'px';
        box.style.marginBottom = newVal;
      });
      qs('#verticalMarginDisplay').textContent = newVal;
      localStorage.setItem('verticalMargin', newVal);
    }
    function adjustHorizontalMargin(pixels){
      let newVal='5px';
      qsa('[class^="word-box"]').forEach(box=>{
        const now = parseFloat(getComputedStyle(box).marginRight) || 5;
        newVal = (now + pixels) + 'px';
        box.style.marginRight = newVal;
      });
      qs('#horizontalMarginDisplay').textContent = newVal;
      localStorage.setItem('horizontalMargin', newVal);
    }
    function loadMargins(){
      const v = localStorage.getItem('verticalMargin') || '10px';
      const h = localStorage.getItem('horizontalMargin') || '5px';
      qsa('[class^="word-box"]').forEach(b=>{
        b.style.marginBottom = v;
        b.style.marginRight = h;
      });
      qs('#verticalMarginDisplay').textContent = v;
      qs('#horizontalMarginDisplay').textContent = h;
    }

    /* ---------- Data loading ---------- */
    function loadText(filename, cb){
      const xhr = new XMLHttpRequest();
      xhr.open('GET', filename, true);
      xhr.onreadystatechange = () => { if (xhr.readyState === 4){ xhr.status === 200 ? cb(xhr.responseText) : console.error("Error loading", filename, xhr.statusText); } };
      xhr.send();
    }
    function loadJSON(url, cb){
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.onreadystatechange = () => { if (xhr.readyState === 4){ xhr.status === 200 ? cb(JSON.parse(xhr.responseText)) : console.error("Error loading", url, xhr.statusText); } };
      xhr.send();
    }
    function loadTransliterations(cb){ loadJSON('transliterations.json', cb); }
    function loadNewTransliterations(cb){ loadJSON('commontransliterations.json', cb); }
    function loadMappings(cb){ loadJSON('mappings.json', cb); }
    function populateDropdown(list){
      const sel = qs('#fileSelector');
      sel.innerHTML = '';
      list.forEach(file=>{
        const opt = document.createElement('option');
        opt.value = file; opt.textContent = file;
        sel.appendChild(opt);
      });
    }
    function loadFileList(){
      loadJSON('files.json', data=>{
        populateDropdown(data.files || []);
        loadSelectedFile();
      });
    }
    function loadSelectedFile(){
      const file = qs('#fileSelector').value;
      displayText(file);
    }

    /* ---------- Transliteration rendering ---------- */
    function toggleTransliteration(el){
      let t = el.querySelector('.transliteration');
      const value = el.getAttribute('data-transliteration');
      if (!t && value){
        t = document.createElement('div');
        t.className = 'transliteration';
        t.textContent = value;
        el.appendChild(t);
      } else if (t){
        t.style.display = (t.style.display === 'none') ? 'block' : 'none';
      }
    }
    function showAllTransliterations(){
      qsa('.word-box1, .word-box2, .word-box3').forEach(box=>{
        const v = box.getAttribute('data-transliteration');
        if (!v) return;
        let t = box.querySelector('.transliteration');
        if (!t){
          t = document.createElement('div'); t.className='transliteration'; t.textContent = v;
          box.appendChild(t);
        } else { t.style.display='block'; }
      });
    }
    function clearAllTransliterations(){
      qsa('.transliteration').forEach(e=> e.style.display='none');
    }
    function updateMissingTransliterations(){
      const unique = [...new Set(state.missingTransliterations)];
      qs('#missingTransliterationsBox').value = unique.join('\n');
    }
    function copyMissingTransliterations(){
      const ta = qs('#missingTransliterationsBox');
      ta.select(); document.execCommand('copy');
    }

    function getDummyTransliteration(word){
      let t = word;
      for (const [pt, bg] of Object.entries(state.phonemeMappings)){
        const re = new RegExp(pt, 'g');
        t = t.replace(re, bg);
      }
      return t;
    }

    function renderText(text){
      state.missingTransliterations = [];
      loadTransliterations(base=>{
        loadNewTransliterations(newT=>{
          state.newTransliterations = newT || {};
          const html = text.split(/(\s+|\n+)/).map(seg=>{
            if (seg === '\n' || /^\s+$/.test(seg)) return seg;
            const clean = seg.toLowerCase().replace(/[\n,.\d:;?!‚Äò‚Äô]/g,'');
            let cls = 'word-box3', val;
            if (base[clean]){ cls='word-box1'; val = base[clean]; }
            else if (state.newTransliterations[clean]){ cls='word-box2'; val = state.newTransliterations[clean]; }
            else {
              if (clean.trim()) state.missingTransliterations.push(clean);
              val = getDummyTransliteration(clean);
            }
            return `<span class="${cls}" data-transliteration="${val}" onclick="(${toggleTransliteration})(this)">${seg}</span>`;
          }).join('');
          qs('#content').innerHTML = html;
          updateMissingTransliterations();
          loadMargins(); // apply saved spacing to fresh nodes
        });
      });
    }

    function displayText(filename='pt.txt'){
      loadText(filename, txt=>{
        renderText(txt || '');
      });
      // swap audio source
      const audioFile = filename.replace('.txt','.mp3');
      audioPlayer.src = audioFile;
      playPauseButton.textContent = '‚ñ∂Ô∏è';
    }

    function displayTextFromContent(text){
      renderText(text || '');
    }

    /* ---------- Paste & Clipboard ---------- */
    async function processClipboardContent(){
      try{
        const text = await navigator.clipboard.readText();
        if (text?.trim()) displayTextFromContent(text);
        else alert('Clipboard est√° vazio.');
      }catch(e){
        console.error(e); alert('Sem permiss√µes para o clipboard.');
      }
    }
    function processPastedContent(){
      const t = qs('#pasteBox').value;
      if (t?.trim()) displayTextFromContent(t);
      else alert('A caixa est√° vazia.');
    }

    /* ---------- Boot ---------- */
    loadMappings(map=>{ state.phonemeMappings = map || {}; });
    loadFileList();
    document.addEventListener('DOMContentLoaded', ()=>{
      adjustHorizontalMargin(5);
      adjustMargin(10);
    });
  </script>
</body>
</html>
